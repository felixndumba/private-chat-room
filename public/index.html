<!DOCTYPE html>
<html>
<head>
  <title>Private Chat with Login</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h2>ðŸ’¬ Private Chat</h2>

  <div id="auth">
    <h3>Register</h3>
    <input id="reg_user" placeholder="Username">
    <input id="reg_pass" type="password" placeholder="Password">
    <button onclick="register()">Register</button>

    <h3>Login</h3>
    <input id="log_user" placeholder="Username">
    <input id="log_pass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <div id="chat" style="display:none;">
    <p>Logged in as <b id="currentUser"></b></p>
    <input id="to" placeholder="Recipient username">
    <input id="message" placeholder="Message">
    <button onclick="sendMessage()">Send</button>
    <ul id="messages"></ul>
  </div>

  <script>
    const socket = io();
    let currentUser = "";

    function register() {
      const username = document.getElementById("reg_user").value;
      const password = document.getElementById("reg_pass").value;

      fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      })
      .then(r => r.text())
      .then(alert);
    }

    function login() {
      const username = document.getElementById("log_user").value;
      const password = document.getElementById("log_pass").value;

      fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      })
      .then(r => r.text())
      .then(msg => {
        alert(msg);
        if (msg.includes("successful")) {
          currentUser = username;
          document.getElementById("auth").style.display = "none";
          document.getElementById("chat").style.display = "block";
          document.getElementById("currentUser").textContent = username;
          socket.emit("authenticate", username);
        }
      });
    }

    function sendMessage() {
      const to = document.getElementById("to").value;
      const message = document.getElementById("message").value;
      socket.emit("private_message", { from: currentUser, to, message });
    }

    socket.on("receive_message", (data) => {
      const li = document.createElement("li");
      li.textContent = `${data.from}: ${data.message}`;
      document.getElementById("messages").appendChild(li);
    });
  </script>
</body>
</html>
